<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deck System Test Suite</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .header {
            background: #2C3E50;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-suite {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-suite h2 {
            margin-top: 0;
            color: #2C3E50;
        }
        .test-result {
            padding: 8px 12px;
            margin: 4px 0;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .test-pass {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        .test-fail {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .test-error {
            color: #721c24;
            font-size: 12px;
            padding-left: 20px;
            margin: 4px 0;
        }
        .summary {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            font-weight: bold;
        }
        .summary.all-pass {
            background: #d4edda;
            color: #155724;
        }
        .summary.some-fail {
            background: #f8d7da;
            color: #721c24;
        }
        .controls {
            margin-bottom: 20px;
        }
        button {
            background: #4A90E2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #357ABD;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß™ Unified Deck System - Automated Test Suite</h1>
        <p>Comprehensive tests for DeckRegistry, PathResolver, and DeckLoader</p>
    </div>

    <div class="controls">
        <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
    </div>

    <div id="results"></div>

    <!-- Load the modules to test -->
    <script src="../decks/shared/DeckRegistry.js"></script>
    <script src="../decks/shared/PathResolver.js"></script>
    <script src="../decks/shared/DeckLoader.js"></script>

    <script>
        // Simple test framework
        class TestSuite {
            constructor(name) {
                this.name = name;
                this.tests = [];
                this.passed = 0;
                this.failed = 0;
                this.results = [];
            }

            test(description, testFn) {
                this.tests.push({ description, testFn });
            }

            assertEqual(actual, expected, message = '') {
                if (actual !== expected) {
                    throw new Error(`${message}\nExpected: ${expected}\nActual: ${actual}`);
                }
            }

            assertTrue(value, message = '') {
                if (!value) {
                    throw new Error(`${message}\nExpected truthy value, got: ${value}`);
                }
            }

            assertFalse(value, message = '') {
                if (value) {
                    throw new Error(`${message}\nExpected falsy value, got: ${value}`);
                }
            }

            assertContains(str, substring, message = '') {
                if (!str || !str.includes(substring)) {
                    throw new Error(`${message}\nExpected "${str}" to contain "${substring}"`);
                }
            }

            assertNotNull(value, message = '') {
                if (value === null || value === undefined) {
                    throw new Error(`${message}\nExpected non-null value, got: ${value}`);
                }
            }

            assertArrayLength(arr, expectedLength, message = '') {
                if (!arr || arr.length !== expectedLength) {
                    throw new Error(`${message}\nExpected array length ${expectedLength}, got ${arr ? arr.length : 'null'}`);
                }
            }

            run() {
                this.passed = 0;
                this.failed = 0;
                this.results = [];

                for (const { description, testFn } of this.tests) {
                    try {
                        testFn.call(this);
                        this.results.push({ description, passed: true });
                        this.passed++;
                    } catch (error) {
                        this.results.push({ description, passed: false, error: error.message });
                        this.failed++;
                    }
                }

                return {
                    name: this.name,
                    passed: this.passed,
                    failed: this.failed,
                    total: this.tests.length,
                    results: this.results
                };
            }
        }

        // =============================================================================
        // Test Suite 1: DeckRegistry Tests
        // =============================================================================

        const registryTests = new TestSuite('DeckRegistry');

        registryTests.test('DeckRegistry should be defined', function() {
            this.assertNotNull(DECK_REGISTRY, 'DECK_REGISTRY should be defined');
        });

        registryTests.test('DeckRegistry should have 4 decks', function() {
            const deckCount = Object.keys(DECK_REGISTRY.decks).length;
            this.assertEqual(deckCount, 4, 'Should have exactly 4 decks');
        });

        registryTests.test('All required decks should exist', function() {
            const expectedDecks = ['rider-waite', 'artistic', 'miro', 'picasso'];
            expectedDecks.forEach(deckId => {
                this.assertNotNull(DECK_REGISTRY.decks[deckId], `Deck ${deckId} should exist`);
            });
        });

        registryTests.test('Rider-Waite deck should have correct configuration', function() {
            const rw = DECK_REGISTRY.decks['rider-waite'];
            this.assertEqual(rw.name, 'Rider-Waite Classic');
            this.assertEqual(rw.folder, 'images');
            this.assertTrue(rw.structure.hasMajorArcanaFolder, 'Should use major arcana folder');
        });

        registryTests.test('Card catalog should have 22 major arcana', function() {
            this.assertArrayLength(DECK_REGISTRY.cards.major, 22, 'Should have 22 major arcana cards');
        });

        registryTests.test('Each minor arcana suit should have 14 cards', function() {
            const suits = ['cups', 'pentacles', 'swords', 'wands'];
            suits.forEach(suit => {
                const cards = DECK_REGISTRY.cards.minor[suit];
                this.assertArrayLength(cards, 14, `${suit} should have 14 cards`);
            });
        });

        // =============================================================================
        // Test Suite 2: PathResolver Tests
        // =============================================================================

        const pathTests = new TestSuite('PathResolver');

        pathTests.test('PathResolver should be defined', function() {
            this.assertNotNull(PathResolver, 'PathResolver should be defined');
        });

        pathTests.test('getBasePath should work from tests subfolder', function() {
            const basePath = PathResolver.getBasePath();
            this.assertNotNull(basePath, 'Should return a base path');
        });

        pathTests.test('resolve should build paths correctly', function() {
            const path = PathResolver.resolve('decks', 'images', 'card.png');
            this.assertContains(path, 'decks');
            this.assertContains(path, 'images');
            this.assertContains(path, 'card.png');
        });

        pathTests.test('isInSubfolder should detect subfolder', function() {
            const inSubfolder = PathResolver.isInSubfolder();
            this.assertTrue(typeof inSubfolder === 'boolean', 'Should return boolean');
        });

        // =============================================================================
        // Test Suite 3: DeckLoader Tests
        // =============================================================================

        const loaderTests = new TestSuite('DeckLoader');

        loaderTests.test('DeckLoader should be defined', function() {
            this.assertNotNull(DeckLoader, 'DeckLoader should be defined');
        });

        loaderTests.test('getAllCards should return 78 cards', function() {
            const allCards = DeckLoader.getAllCards();
            this.assertArrayLength(allCards, 78, 'Should return exactly 78 cards');
        });

        loaderTests.test('getCardById should find The Fool', function() {
            const fool = DeckLoader.getCardById(0);
            this.assertNotNull(fool, 'Should find card with id 0');
            this.assertEqual(fool.name, 'The Fool');
        });

        loaderTests.test('getCardByName should find The Magician', function() {
            const magician = DeckLoader.getCardByName('The Magician');
            this.assertNotNull(magician, 'Should find The Magician');
            this.assertEqual(magician.id, 1);
        });

        loaderTests.test('getCardByName should handle minor arcana', function() {
            const aceOfCups = DeckLoader.getCardByName('Ace of Cups');
            this.assertNotNull(aceOfCups, 'Should find Ace of Cups');
            this.assertEqual(aceOfCups.type, 'minor');
            this.assertEqual(aceOfCups.suit, 'cups');
        });

        loaderTests.test('getImagePath should generate paths for all decks', function() {
            const fool = DeckLoader.getCardById(0);
            const decks = ['rider-waite', 'artistic', 'miro', 'picasso'];

            decks.forEach(deckId => {
                const path = DeckLoader.getImagePath(deckId, fool);
                this.assertNotNull(path, `Deck ${deckId} should generate path`);
                this.assertContains(path, 'the-fool', `Path should contain card name`);
            });
        });

        loaderTests.test('getThumbnailPath should generate WebP and JPEG paths', function() {
            const fool = DeckLoader.getCardById(0);

            const webpPath = DeckLoader.getThumbnailPath('rider-waite', fool, 'webp');
            this.assertContains(webpPath, '.webp', 'Should generate WebP path');

            const jpegPath = DeckLoader.getThumbnailPath('rider-waite', fool, 'jpg');
            this.assertContains(jpegPath, '.jpg', 'Should generate JPEG path');
        });

        loaderTests.test('transformRiderWaiteFilename should convert number words', function() {
            const tests = [
                { input: 'ace-of-cups', expected: '1-of-cups' },
                { input: 'two-of-wands', expected: '2-of-wands' },
                { input: 'page-of-cups', expected: '11-of-cups' },
                { input: 'king-of-pentacles', expected: '14-of-pentacles' }
            ];

            tests.forEach(({ input, expected }) => {
                const result = DeckLoader.transformRiderWaiteFilename(input);
                this.assertEqual(result, expected, `Should convert ${input} to ${expected}`);
            });
        });

        loaderTests.test('createResponsiveImage should create picture element', function() {
            const fool = DeckLoader.getCardById(0);
            const picture = DeckLoader.createResponsiveImage('rider-waite', fool, {
                thumbnail: true,
                loading: 'lazy'
            });

            this.assertEqual(picture.tagName, 'PICTURE', 'Should create picture element');
            this.assertTrue(picture.children.length >= 2, 'Should have source and img children');
        });

        loaderTests.test('All 78 cards should generate valid paths', function() {
            const allCards = DeckLoader.getAllCards();
            let invalidPaths = 0;

            allCards.forEach(card => {
                try {
                    const path = DeckLoader.getImagePath('rider-waite', card);
                    if (!path || path.length === 0) invalidPaths++;
                } catch (e) {
                    invalidPaths++;
                }
            });

            this.assertEqual(invalidPaths, 0, `All cards should generate valid paths, found ${invalidPaths} invalid`);
        });

        // =============================================================================
        // Test Suite 4: Integration Tests
        // =============================================================================

        const integrationTests = new TestSuite('Integration Tests');

        integrationTests.test('Complete workflow: Get card, generate paths, create image', function() {
            const card = DeckLoader.getCardByName('The Magician');
            this.assertNotNull(card, 'Should find The Magician');

            const imagePath = DeckLoader.getImagePath('rider-waite', card);
            this.assertContains(imagePath, '01-the-magician', 'Should generate correct path');

            const thumbPath = DeckLoader.getThumbnailPath('rider-waite', card, 'webp');
            this.assertContains(thumbPath, '01-the-magician.webp', 'Should generate thumbnail path');

            const picture = DeckLoader.createResponsiveImage('rider-waite', card, { thumbnail: true });
            this.assertEqual(picture.tagName, 'PICTURE', 'Should create picture element');
        });

        integrationTests.test('All decks should work with all 78 cards', function() {
            const decks = ['rider-waite', 'artistic', 'miro', 'picasso'];
            const allCards = DeckLoader.getAllCards();
            let errors = 0;

            decks.forEach(deckId => {
                allCards.forEach(card => {
                    try {
                        const path = DeckLoader.getImagePath(deckId, card);
                        if (!path || path.length === 0) errors++;
                    } catch (e) {
                        errors++;
                    }
                });
            });

            this.assertEqual(errors, 0, `All deck/card combinations should work, found ${errors} errors`);
        });

        // =============================================================================
        // Run Tests and Display Results
        // =============================================================================

        function runAllTests() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            const suites = [registryTests, pathTests, loaderTests, integrationTests];
            let totalPassed = 0;
            let totalFailed = 0;
            let totalTests = 0;

            suites.forEach(suite => {
                const result = suite.run();
                totalPassed += result.passed;
                totalFailed += result.failed;
                totalTests += result.total;

                const suiteDiv = document.createElement('div');
                suiteDiv.className = 'test-suite';

                const title = document.createElement('h2');
                title.textContent = `${result.name} (${result.passed}/${result.total} passed)`;
                suiteDiv.appendChild(title);

                result.results.forEach(test => {
                    const testDiv = document.createElement('div');
                    testDiv.className = `test-result ${test.passed ? 'test-pass' : 'test-fail'}`;
                    testDiv.textContent = `${test.passed ? '‚úÖ' : '‚ùå'} ${test.description}`;
                    suiteDiv.appendChild(testDiv);

                    if (!test.passed && test.error) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'test-error';
                        errorDiv.textContent = test.error;
                        suiteDiv.appendChild(errorDiv);
                    }
                });

                const summary = document.createElement('div');
                summary.className = `summary ${result.failed === 0 ? 'all-pass' : 'some-fail'}`;
                summary.textContent = `${result.passed} passed, ${result.failed} failed, ${result.total} total`;
                suiteDiv.appendChild(summary);

                resultsDiv.appendChild(suiteDiv);
            });

            // Overall summary
            const overallDiv = document.createElement('div');
            overallDiv.className = 'test-suite';
            overallDiv.innerHTML = `
                <h2>üìä Overall Test Results</h2>
                <div class="summary ${totalFailed === 0 ? 'all-pass' : 'some-fail'}">
                    ${totalPassed} passed, ${totalFailed} failed, ${totalTests} total tests
                    ${totalFailed === 0 ? '<br>üéâ All tests passed!' : '<br>‚ö†Ô∏è Some tests failed'}
                </div>
            `;
            resultsDiv.appendChild(overallDiv);

            // Log to console as well
            console.log(`\nüìä Test Results: ${totalPassed}/${totalTests} passed`);
            if (totalFailed === 0) {
                console.log('üéâ All tests passed!');
            } else {
                console.warn(`‚ö†Ô∏è ${totalFailed} tests failed`);
            }
        }

        // Auto-run on load
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 500);
        });
    </script>
</body>
</html>
